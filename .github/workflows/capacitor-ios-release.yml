name: Mobile Release (iOS)

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release-ios-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-ios:
    runs-on: macos-14
    timeout-minutes: 45
    strategy:
      matrix:
        include:
          - destination: 'platform=iOS Simulator,name=iPhone 15'
            arch: simulator
          - destination: 'generic/platform=iOS'
            arch: device

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 20.19.0
          cache: npm

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install dependencies
        run: npm ci

      - name: Integrity attestation
        run: |
          npm run integrity | tee integrity-attestation-ios-${{ matrix.arch }}.txt

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor (iOS)
        run: npx --no-install cap sync ios

      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install --repo-update

      - name: Build iOS ${{ matrix.arch }}
        run: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -destination '${{ matrix.destination }}' \
            -configuration Release \
            clean build \
            CODE_SIGNING_ALLOWED=NO

      - name: Package iOS Simulator build
        if: matrix.arch == 'simulator'
        run: |
          APP_PATH=$(find ios/App/build -name "*.app" -type d | head -n 1)
          if [ -n "$APP_PATH" ]; then
            zip -r ghost-privacy-ios-simulator.app.zip "$APP_PATH"
            shasum -a 256 ghost-privacy-ios-simulator.app.zip > ghost-privacy-ios-simulator.sha256
          fi

      - name: Package iOS Device build (unsigned IPA)
        if: matrix.arch == 'device'
        run: |
          APP_PATH=$(find ios/App/build -name "*.app" -type d | head -n 1)
          if [ -n "$APP_PATH" ]; then
            mkdir -o Payload
            cp -r "$APP_PATH" Payload/
            zip -r ghost-privacy-ios-unsigned.ipa Payload/
            rm -rf Payload
            shasum -a 256 ghost-privacy-ios-unsigned.ipa > ghost-privacy-ios-device.sha256
          fi

      - name: Attest build provenance (iOS ${{ matrix.arch }})
        uses: actions/attest-build-provenance@ef244123eb79f2f7a7e75d99086184180e6d0018
        with:
          subject-path: |
            ghost-privacy-ios-*.zip
            ghost-privacy-ios-*.ipa
            ghost-privacy-ios-*.sha256
            integrity-attestation-ios-*.txt

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ios-${{ matrix.arch }}-artifacts
          path: |
            ghost-privacy-ios-*.zip
            ghost-privacy-ios-*.ipa
            ghost-privacy-ios-*.sha256
            integrity-attestation-ios-*.txt

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          files: |
            ghost-privacy-ios-*.zip
            ghost-privacy-ios-*.ipa
            ghost-privacy-ios-*.sha256
            integrity-attestation-ios-*.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
