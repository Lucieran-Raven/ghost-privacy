name: Tor Hidden Service

on:
  schedule:
    - cron: '*/55 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/tor-service.yml'
      - '.github/tor/**'

jobs:
  deploy-tor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Tor
      run: |
        sudo apt-get update
        sudo apt-get install -y tor python3-pip
        pip3 install requests
        
    - name: Create Tor directories
      run: |
        mkdir -p .github/tor/hidden_service
        mkdir -p .github/tor/logs
        
    - name: Start Tor service
      run: |
        tor -f .github/tor/torrc &
        sleep 10
        
    - name: Wait for hidden service to be ready
      run: |
        timeout 60 bash -c 'until [ -f ".github/tor/hidden_service/hostname" ]; do sleep 1; done'
        
    - name: Get .onion address
      id: onion-address
      run: |
        ONION_ADDRESS=$(cat .github/tor/hidden_service/hostname)
        echo "address=$ONION_ADDRESS" >> $GITHUB_OUTPUT
        echo "ðŸ” Tor Hidden Service Address: $ONION_ADDRESS"
        
    - name: Start proxy server
      run: |
        cd .github/tor
        python3 proxy.py &
        sleep 5
        
    - name: Test Tor service
      run: |
        ONION_ADDRESS=$(cat .github/tor/hidden_service/hostname)
        echo "Testing connection to $ONION_ADDRESS..."
        timeout 30 torsocks curl -s --connect-timeout 10 "http://$ONION_ADDRESS/" | head -20 || true
        
    - name: Persist Tor keys
      run: |
        chmod 600 .github/tor/hidden_service/private_key
        
    - name: Commit .onion address if new
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .github/tor/hidden_service/hostname
        git add .github/tor/hidden_service/private_key
        git commit -m "Add Tor hidden service keys for persistent .onion address" || true
        git push || true
        
    - name: Job Summary
      run: |
        ONION_ADDRESS="${{ steps.onion-address.outputs.address }}"
        echo "## ðŸ” Tor Hidden Service Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Your persistent .onion address:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "$ONION_ADDRESS" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Service is running and will auto-restart every 55 minutes" >> $GITHUB_STEP_SUMMARY
        
    - name: Keep service alive
      run: |
        ONION_ADDRESS=$(cat .github/tor/hidden_service/hostname)
        echo "Tor hidden service is running at: $ONION_ADDRESS"
        echo "Proxy server is running on port 8080"
        sleep 3000
