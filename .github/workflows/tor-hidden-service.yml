name: Tor Hidden Service

on:
  schedule:
    - cron: '*/55 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/tor-hidden-service.yml'
      - '.github/tor/**'

jobs:
  deploy-tor:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore Tor state (best-effort)
        uses: actions/cache@v4
        with:
          path: |
            .github/tor/hidden_service
            .github/tor/data
          key: tor-hidden-service-v1

      - name: Setup Tor
        run: |
          sudo apt-get update
          sudo apt-get install -y tor torsocks python3-pip
          pip3 install requests

      - name: Prepare Tor directories
        run: |
          mkdir -p .github/tor/hidden_service
          mkdir -p .github/tor/data
          touch .github/tor/tor.log
          chmod 700 .github/tor/hidden_service
          chmod 700 .github/tor/data
          chmod 600 .github/tor/tor.log
          if [ -f .github/tor/hidden_service/private_key ]; then chmod 600 .github/tor/hidden_service/private_key; fi

      - name: Verify Tor config
        run: |
          tor --verify-config -f .github/tor/torrc

      - name: Start Tor
        run: |
          tor -f .github/tor/torrc &
          sleep 2

      - name: Wait for hostname
        run: |
          timeout 180 bash -c 'until [ -f ".github/tor/hidden_service/hostname" ]; do sleep 1; done'

      - name: Show Tor log
        if: always()
        run: |
          echo "--- tor.log ---"
          cat .github/tor/tor.log || true

      - name: Fail if hostname missing
        run: |
          test -f .github/tor/hidden_service/hostname

      - name: Get .onion address
        id: onion
        run: |
          ONION=$(cat .github/tor/hidden_service/hostname)
          echo "onion=$ONION" >> $GITHUB_OUTPUT
          echo "Tor Hidden Service Address: $ONION"

      - name: Start proxy
        run: |
          python3 .github/tor/proxy.py &
          sleep 2

      - name: Test via torsocks
        run: |
          ONION=$(cat .github/tor/hidden_service/hostname)
          timeout 30 torsocks curl -s --connect-timeout 10 "http://$ONION/" | head -20 || true

      - name: Job Summary
        run: |
          ONION="${{ steps.onion.outputs.onion }}"
          echo "## Tor Hidden Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**.onion address:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$ONION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Keep alive (runner limit applies)
        run: |
          sleep 3000